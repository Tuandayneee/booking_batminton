{% extends 'base/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Đặt lịch - Badminton Pro{% endblock %}

{% block content %}
<div class="container" style="padding-top: 100px; padding-bottom: 100px;"> 
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-dark mb-0">Đặt lịch trực quan</h3>
        
        <div class="d-flex gap-2">
            <div class="input-group-unified bg-white shadow-sm" style="width: auto;">
                <span class="input-group-text pe-2"><i class="fa-regular fa-calendar"></i></span>
                <input type="date" 
                       id="bookingDate" 
                       class="form-control fw-bold border-0" 
                       value="{{ selected_date }}" 
                       min="{{ min_date }}" 
                       max="{{ max_date }}" 
                       onchange="window.location.href='?date=' + this.value">
            </div>
        </div>
    </div>

    <div class="d-flex gap-4 mb-4 small fade-in-up">
        <div class="d-flex align-items-center gap-2">
            <div class="border rounded bg-white" style="width: 20px; height: 20px;"></div>
            <span class="text-secondary">Trống</span>
        </div>
        <div class="d-flex align-items-center gap-2">
            <div class="rounded" style="width: 20px; height: 20px; background-color: #fee2e2;"></div>
            <span class="text-secondary">Đã đặt</span>
        </div>
        <div class="d-flex align-items-center gap-2">
            <div class="rounded" style="width: 20px; height: 20px; background-color: #fef3c7;"></div>
            <span class="text-secondary">Đang giữ chỗ</span>
        </div>
        <div class="d-flex align-items-center gap-2">
            <div class="rounded" style="width: 20px; height: 20px; background-color: var(--brand-accent);"></div>
            <span class="text-secondary fw-bold">Đang chọn</span>
        </div>
        <div class="d-flex align-items-center gap-2">
            <div class="rounded" style="width: 20px; height: 20px; background-color: #6d6d6e;"></div>
            <span class="text-secondary fw-bold">Đã qua giờ</span>
        </div>
    </div>

    <div class="booking-timeline-wrapper shadow-sm fade-in-up" style="animation-delay: 0.1s;">
        <table class="booking-table">
            <thead>
                <tr>
                    <th class="court-name-col border-bottom">Sân</th>
                    {% for time in time_labels %}
                        <th class="time-header">{{ time }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for item in courts_data %}
                <tr>
                    <td class="court-name-col">
                        <div class="d-flex flex-column align-items-center">
                            <span>{{ item.court_obj.name }}</span>
                            <span class="badge bg-light text-secondary border fw-normal mt-1" style="font-size: 0.6rem;">
                                {{ item.court_obj.get_type_court_display }}
                            </span>
                        </div>
                    </td>
                    
                    {% for slot in item.slots %}
                    <td class="booking-slot {{ slot.status }} position-relative" 
                        data-court-id="{{ item.court_obj.id }}" 
                        data-court-name="{{ item.court_obj.name }}"
                        data-time="{{ slot.time }}"
                        data-price="{{ slot.price }}"
                        
                        {# --- GIỮ NGUYÊN PHẦN LOGIC KHÓA SÂN THEO THỜI GIAN CỦA BẠN TẠI ĐÂY --- #}
                        {% if slot.status == 'booked' %}
                            title="Đã có người đặt"
                            style="cursor: not-allowed; background-color: #fee2e2;"
                            
                        {% elif slot.status == 'locked' %}
                            title="Đang có người giữ chỗ"
                            style="cursor: not-allowed; background-color: #fef3c7;"
                            
                        {% elif slot.status == 'expired' or slot.status == 'completed' %}
                            title="Đã qua thời gian đặt"
                            style="cursor: not-allowed; background-color: #6d6d6e; color: #9ca3af;"
                            
                        {% else %}
                            title="Sân trống: {{ slot.time }}"
                            onclick="toggleSlot(this)"
                            style="cursor: pointer;"
                        {% endif %}
                    >
                        {% if slot.is_golden and slot.status == 'free' %}
                            <i class="fa-solid fa-bolt text-warning position-absolute top-0 end-0 m-1" style="font-size: 8px;"></i>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="booking-footer slide-up">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <small class="text-muted d-block">Tổng tạm tính</small>
                <div class="d-flex align-items-baseline">
                    <h3 class="fw-bold text-primary mb-0" id="totalPrice">0đ</h3>
                    <span class="text-secondary ms-2 small" id="totalHours">(0h)</span>
                </div>
            </div>
            
            <form method="POST" action="{% url 'booking_confirm' %}" id="bookingForm">
                {% csrf_token %}
                <input type="hidden" name="booking_data" id="bookingDataInput">
                <input type="hidden" name="selected_date" id="selectedDateInput">
                <input type="hidden" name="center_id" value="{{ center.id }}">

                <button type="button" id="btnSubmit" onclick="submitBooking()" class="btn btn-login-premium px-5 py-3 rounded-pill shadow-lg">
                    <span class="spinner-border spinner-border-sm d-none me-2"></span>
                    Tiếp theo <i class="fa-solid fa-arrow-right ms-2"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    let selectedSlots = []; 
    let total = 0;
    
    // Lấy ID user từ Django Template (Quan trọng cho FastAPI)
    const userId = "{{ request.user.id }}"; 

    // 1. Hàm chọn/bỏ chọn ô (Giữ nguyên logic của bạn)
    function toggleSlot(element) {
        const courtId = element.getAttribute('data-court-id');
        const courtName = element.getAttribute('data-court-name');
        const time = element.getAttribute('data-time');
        const pricePerHour = parseFloat(element.getAttribute('data-price'));
        const pricePerSlot = pricePerHour / 2; 

        const slotKey = `${courtId}_${time}`;

        if (element.classList.contains('selected')) {
            element.classList.remove('selected');
            total -= pricePerSlot;
            selectedSlots = selectedSlots.filter(slot => slot.key !== slotKey);
        } else {
            element.classList.add('selected');
            total += pricePerSlot;
            selectedSlots.push({
                key: slotKey, court_id: courtId, court_name: courtName, time: time, price: pricePerSlot
            });
        }
        updateFooter();
    }

    function updateFooter() {
        document.getElementById('totalPrice').innerText = total.toLocaleString('vi-VN') + 'đ';
        const totalHours = selectedSlots.length * 0.5;
        document.getElementById('totalHours').innerText = '(' + totalHours + 'h)';
    }

    // 2. Hàm Submit mới (Gọi FastAPI Lock trước khi gửi)
    async function submitBooking() {
        // Kiểm tra user đăng nhập
        if (!userId || userId === "None") {
            alert("Vui lòng đăng nhập để đặt sân!");
            window.location.href = "/login/";
            return;
        }

        // Kiểm tra đã chọn slot chưa
        if (selectedSlots.length === 0) {
            alert("Vui lòng chọn ít nhất một khung giờ!");
            return;
        }

        // Hiệu ứng Loading cho nút
        const btn = document.getElementById('btnSubmit');
        const spinner = btn.querySelector('.spinner-border');
        btn.disabled = true;
        spinner.classList.remove('d-none');

        const dateValue = document.getElementById('bookingDate').value;

        // --- GỌI FASTAPI ĐỂ KHÓA HÀNG LOẠT ---
        // Map từng slot thành các request fetch song song
        const lockPromises = selectedSlots.map(slot => {
            return fetch('http://localhost:8001/api/v1/lock-slot/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    court_id: parseInt(slot.court_id),
                    date: dateValue,
                    start_time: slot.time,
                    end_time: slot.time, // Gửi cho đủ model, FastAPI không dùng
                    user_id: parseInt(userId)
                })
            }).then(async res => {
                try {
                    const data = await res.json();
                    return { 
                        ok: res.ok, 
                        detail: data.detail || (res.ok ? 'Thành công' : 'Lỗi không xác định'), 
                        time: slot.time, 
                        court: slot.court_name 
                    };
                } catch (jsonErr) {
                    // Response không phải JSON (500 error hoặc server không phản hồi đúng)
                    return { 
                        ok: false, 
                        detail: `Lỗi server (HTTP ${res.status})`, 
                        time: slot.time, 
                        court: slot.court_name 
                    };
                }
            }).catch(err => {
                // Network error - FastAPI không chạy hoặc không kết nối được
                return { 
                    ok: false, 
                    detail: 'Không thể kết nối server đặt sân. Vui lòng kiểm tra FastAPI đang chạy!', 
                    time: slot.time, 
                    court: slot.court_name 
                };
            });
        });

        try {
            // Chờ tất cả request hoàn thành
            const results = await Promise.all(lockPromises);
            
            // Lọc ra các slot bị lỗi (bị người khác khóa trước)
            const failedLocks = results.filter(r => !r.ok);

            if (failedLocks.length > 0) {
                let msg = "Rất tiếc, các khung giờ sau vừa bị người khác đặt:\n";
                failedLocks.forEach(f => msg += `- Sân ${f.court} (${f.time}): ${f.detail}\n`);
                msg += "\nVui lòng bỏ chọn các ô màu đỏ và thử lại.";
                
                alert(msg);
                location.reload(); // Tải lại trang để cập nhật trạng thái mới nhất
                return;
            }

            // --- NẾU TẤT CẢ THÀNH CÔNG -> SUBMIT FORM SANG DJANGO ---
            document.getElementById('selectedDateInput').value = dateValue;
            // Chuyển object selectedSlots thành JSON string để gửi đi
            document.getElementById('bookingDataInput').value = JSON.stringify(selectedSlots);
            document.getElementById('bookingForm').submit();

        } catch (e) {
            console.error(e);
            alert("Lỗi kết nối đến server đặt sân. Vui lòng thử lại!");
            btn.disabled = false;
            spinner.classList.add('d-none');
        }
    }
</script>
{% endblock %}