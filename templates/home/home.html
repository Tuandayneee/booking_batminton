{% extends 'base/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Trang chủ - Badminton Pro{% endblock %}

{% block content %}
<section class="hero-section">
    <div class="hero-bg-image" style="background-image: url('{% static 'images/banner.jpg' %}');"></div>
    <div class="hero-overlay"></div>

    <div class="container hero-content">
        <div class="row align-items-center">
            
            <div class="col-lg-7 text-white mb-5 mb-lg-0 fade-in-up">
                <div class="badge-hero">
                    <span class="d-inline-block rounded-circle bg-success" style="width: 8px; height: 8px;"></span>
                    <span>Nền tảng số 1 Việt Nam</span>
                </div>

                <h1 class="hero-title display-3 mb-4">
                    Chinh phục đỉnh cao <br>
                    <span style="color: #94a3b8;">Đam mê cầu lông</span>
                </h1>

                <p class="lead text-white-50 mb-5" style="max-width: 550px;">
                    Hệ thống đặt sân thông minh, kết nối cộng đồng vợt thủ toàn quốc. 
                    Tìm sân gần nhất và thanh toán chỉ trong 30 giây.
                </p>
                
                <div class="d-flex gap-3">
                    <a href="#courts" class="btn btn-login-premium px-4 py-3">
                        Đặt sân ngay
                    </a>
                    <a href="#" class="btn btn-outline-light fw-bold px-4 py-3 rounded-3" style="border: 1px solid rgba(255,255,255,0.2);">
                        <i class="fa-solid fa-play me-2"></i>Xem Demo
                    </a>
                </div>
            </div>

            <div class="col-lg-5 ms-auto fade-in-up" style="animation-delay: 0.2s;">
                <div class="search-card-floating">
                    <h4 class="fw-bold text-dark mb-4 d-flex align-items-center">
                        <i class="fa-solid fa-magnifying-glass me-2 text-primary"></i>
                        Tìm sân nhanh
                    </h4>
                    
                    <form id="fast-search-form">
                        <div class="mb-3">
                            <label class="form-label">Ngày chơi</label>
                            <div class="input-group-unified">
                                <span class="input-group-text"><i class="fa-regular fa-calendar"></i></span>
                                <input type="date" id="input-date" class="form-control" value="{% now 'Y-m-d' %}" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Khu vực (Hà Nội)</label>
                            <div class="input-group-unified">
                                <span class="input-group-text"><i class="fa-solid fa-location-dot"></i></span>
                                <select id="input-address" class="form-select form-control">
                                    <option value="" selected>Tất cả khu vực</option>
                                    </select>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label">Giờ bắt đầu</label>
                            <div class="input-group-unified">
                                <span class="input-group-text"><i class="fa-regular fa-clock"></i></span>
                                <input type="time" id="input-time" class="form-control" value="17:00" step="1800" required>
                            </div>
                            <div class="form-text small text-muted">*Tìm sân trống trong vòng 1h kể từ giờ chọn.</div>
                        </div>
                        
                        <button type="submit" id="btn-search" class="btn btn-login-premium w-100 py-3 shadow-sm">
                            <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                            Tìm kiếm ngay
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</section>

<section class="py-5 bg-body">
    <div class="container py-lg-5">
        <div class="row g-4">
            <div class="col-md-4 fade-in-up" style="animation-delay: 0.1s;">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fa-regular fa-calendar-check"></i>
                    </div>
                    <h5 class="fw-bold mb-3 text-dark">Đặt sân siêu tốc</h5>
                    <p class="text-secondary mb-0 small">Xem tình trạng sân trống theo thời gian thực. Đặt lịch và giữ chỗ chỉ với 3 cú chạm.</p>
                </div>
            </div>
            <div class="col-md-4 fade-in-up" style="animation-delay: 0.2s;">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fa-solid fa-shield-halved"></i>
                    </div>
                    <h5 class="fw-bold mb-3 text-dark">Thanh toán an toàn</h5>
                    <p class="text-secondary mb-0 small">Hỗ trợ đa dạng phương thức: QR Code, Ví điện tử. Hoàn tiền tự động nếu hủy lịch.</p>
                </div>
            </div>
            <div class="col-md-4 fade-in-up" style="animation-delay: 0.3s;">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fa-solid fa-medal"></i>
                    </div>
                    <h5 class="fw-bold mb-3 text-dark">Hạng thành viên</h5>
                    <p class="text-secondary mb-0 small">Tích lũy điểm thưởng sau mỗi lần đặt sân để nâng hạng VIP và nhận ưu đãi độc quyền.</p>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="py-5 bg-body" id="courts">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-end mb-5">
            <div>
                <span class="text-primary fw-bold text-uppercase small ls-tight">Điểm đến yêu thích</span>
                <h2 class="fw-bold mb-0 mt-1 text-dark">Sân cầu lông nổi bật</h2>
            </div>
            <a href="#" class="btn btn-outline-secondary rounded-pill px-4 fw-bold small">Xem tất cả <i class="fa-solid fa-arrow-right ms-2"></i></a>
        </div>

        <div class="row g-4" id="courts-container">
            
            {% for center in centers %}
                <div class="col-md-6 col-lg-4">
                    <div class="card court-card h-100">
                        <div class="court-img-wrapper">
                            {% if center.image %}
                                <img src="{{ center.image.url }}" class="court-img-top" alt="{{ center.name }}">
                            {% else %}
                                <img src="https://placehold.co/600x400/e2e8f0/64748b?text=No+Image" class="court-img-top" alt="No Image">
                            {% endif %}

                            {% if center.is_active %}
                                <div class="court-badge court-badge-type" style="background: rgba(16, 185, 129, 0.9);">
                                    <i class="fa-solid fa-circle-check me-1"></i>Đang hoạt động
                                </div>
                            {% else %}
                                <div class="court-badge court-badge-type" style="background: rgba(100, 116, 139, 0.9);">
                                    <i class="fa-solid fa-lock me-1"></i>Tạm dừng
                                </div>
                            {% endif %}
                        </div>

                        <div class="card-body p-4">
                            <h6 class="fw-bold text-dark mb-1">{{ center.name }}</h6>
                            <p class="text-secondary small mb-3">
                                <i class="fa-solid fa-location-dot me-1 text-danger"></i> {{ center.address }}
                            </p>
                            
                            <div class="d-flex flex-wrap gap-2 mb-4">
                                {% for amenity in center.amenities.all|slice:":3" %}
                                    <span class="badge badge-soft-secondary text-secondary bg-light border fw-normal">
                                        {{ amenity.name }}
                                    </span>
                                {% empty %}
                                    <span class="text-muted small fst-italic">Đang cập nhật tiện ích</span>
                                {% endfor %}
                            </div>

                            <div class="d-flex align-items-center justify-content-between pt-3 border-top border-light">
                                <div>
                                    <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Giá từ</small>
                                    <span class="fw-bold text-primary fs-5">
                                        {% if center.min_price %}
                                            {{ center.min_price|intcomma }}đ
                                        {% else %}
                                            Liên hệ
                                        {% endif %}
                                    </span>
                                    {% if center.min_price %}
                                        <small class="text-muted">/h</small>
                                    {% endif %}
                                </div>
                                
                                <a href="{% url 'booking_timeline' center.id%}" class="btn btn-sm btn-login-premium rounded-pill px-4">
                                    Đặt ngay
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12 text-center py-5">
                    <p class="text-muted">Chưa có sân nào được đăng ký.</p>
                </div>
            {% endfor %} </div> </div>
</section>

<section class="py-5 bg-body">
    <div class="container py-4">
        <div class="partner-section p-5">
            <div class="partner-bg-pattern"></div>
            <div class="row position-relative z-1 align-items-center">
                <div class="col-lg-7 text-white">
                    <span class="badge bg-body text-dark mb-3 px-3 py-2 fw-bold text-uppercase" style="font-size: 0.7rem;">Dành cho chủ sân</span>
                    <h2 class="display-5 fw-bold mb-4">Hợp tác cùng phát triển</h2>
                    <p class="lead text-white-50 mb-4 fs-6">
                        Tối ưu hóa doanh thu, quản lý lịch đặt sân thông minh và tiếp cận hàng ngàn khách hàng tiềm năng mỗi tháng cùng Badminton Pro.
                    </p>
                    <div class="d-flex gap-3">
                        <a href="{% url 'register_partner' %}" class="btn btn-light text-dark rounded-pill px-5 py-3 fw-bold shadow-lg">
                            Đăng ký đối tác
                        </a>
                        <a href="{% url 'partner_info'%}" class="btn btn-outline-light rounded-pill px-4 py-3 fw-bold">
                            Tìm hiểu thêm
                        </a>
                    </div>
                </div>
                </div>
        </div>
    </div>
</section>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('fast-search-form');
    const courtsContainer = document.getElementById('courts-container');
    const btnSearch = document.getElementById('btn-search');
    const spinner = btnSearch.querySelector('.spinner-border');
    const addressSelect = document.getElementById('input-address');

    // Cấu hình URL FastAPI
    const BASE_API_URL = "http://localhost:8001/api/v1";

    // --- 1. HÀM LOAD QUẬN/HUYỆN ---
    async function loadDistricts() {
        try {
            const response = await fetch(`${BASE_API_URL}/districts/`);
            if (!response.ok) return;
            
            const districts = await response.json();
            
            // Xóa các option cũ (trừ option đầu tiên)
            while (addressSelect.options.length > 1) {
                addressSelect.remove(1);
            }

            // Thêm option mới
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                addressSelect.appendChild(option);
            });
        } catch (error) {
            console.error("Lỗi tải danh sách quận:", error);
        }
    }

    // Gọi hàm load quận ngay khi trang tải xong
    loadDistricts();

    // --- 2. XỬ LÝ TÌM KIẾM ---
    searchForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Lấy dữ liệu
        const date = document.getElementById('input-date').value;
        const address = addressSelect.value;
        const inputTime = document.getElementById('input-time').value; // Dạng "17:30"

        if (!inputTime) {
            alert("Vui lòng chọn giờ chơi!");
            return;
        }

        // Logic tính giờ kết thúc (Mặc định tìm slot 1 tiếng)
        // VD: Khách chọn 17:30 -> Tìm sân trống từ 17:30 đến 18:30
        const startTime = inputTime;
        let [hours, minutes] = inputTime.split(':').map(Number);
        
        // Cộng thêm 1 giờ
        let endHours = hours + 1;
        let endMinutes = minutes;
        
        // Format lại thành chuỗi HH:MM
        const endTime = `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;

        // Hiệu ứng Loading
        btnSearch.disabled = true;
        spinner.classList.remove('d-none');
        btnSearch.childNodes[2].textContent = " Đang tìm...";
        
        try {
            // Tạo URL tìm kiếm
            const url = new URL(`${BASE_API_URL}/search/`);
            url.searchParams.append('date', date);
            url.searchParams.append('start_time', startTime);
            url.searchParams.append('end_time', endTime); // Gửi end_time tự tính
            if (address) url.searchParams.append('address', address);

            const response = await fetch(url);
            if (!response.ok) throw new Error('Lỗi kết nối server');
            
            const centers = await response.json();
            renderCourts(centers);
            
            // Cuộn xuống kết quả
            document.getElementById('courts').scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            console.error(error);
            alert('Có lỗi xảy ra. Vui lòng kiểm tra kết nối FastAPI!');
        } finally {
            btnSearch.disabled = false;
            spinner.classList.add('d-none');
            btnSearch.childNodes[2].textContent = "Tìm kiếm ngay";
        }
    });

    // Hàm render giữ nguyên như cũ
    function renderCourts(centers) {
        // ... (Copy lại hàm renderCourts ở câu trả lời trước vào đây) ...
        // Logic render HTML không thay đổi
        if (centers.length === 0) {
            courtsContainer.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="text-muted opacity-50 mb-3"><i class="fa-regular fa-face-frown-open fa-3x"></i></div>
                    <h5 class="text-muted">Không tìm thấy sân trống</h5>
                    <p class="small text-secondary">Thử đổi giờ hoặc khu vực khác xem sao nhé!</p>
                </div>`;
            return;
        }

        let html = '';
        centers.forEach(center => {
            const priceFormatted = new Intl.NumberFormat('vi-VN').format(center.lowest_price);
            const imgUrl = center.image ? center.image : 'https://placehold.co/600x400/e2e8f0/64748b?text=No+Image';
            const availableCount = center.available_courts.length;

            html += `
            <div class="col-md-6 col-lg-4 fade-in-up">
                <div class="card court-card h-100">
                    <div class="court-img-wrapper">
                        <img src="${imgUrl}" class="court-img-top" alt="${center.name}" onerror="this.src='https://placehold.co/600x400/e2e8f0/64748b?text=No+Image'">
                        <div class="court-badge court-badge-type" style="background: rgba(16, 185, 129, 0.9);">
                            <i class="fa-solid fa-bolt me-1"></i>Còn ${availableCount} sân
                        </div>
                    </div>

                    <div class="card-body p-4">
                        <h6 class="fw-bold text-dark mb-1">${center.name}</h6>
                        <p class="text-secondary small mb-3">
                            <i class="fa-solid fa-location-dot me-1 text-danger"></i> ${center.address}
                        </p>
                        
                        <div class="d-flex align-items-center justify-content-between pt-3 border-top border-light">
                            <div>
                                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Giá từ</small>
                                <span class="fw-bold text-primary fs-5">${priceFormatted}đ</span>
                                <small class="text-muted">/h</small>
                            </div>
                            
                            <a href="/booking/timeline/${center.id}/" class="btn btn-sm btn-login-premium rounded-pill px-4">
                                Đặt ngay
                            </a>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        courtsContainer.innerHTML = html;
    }
    
});
</script>
{% endblock %}